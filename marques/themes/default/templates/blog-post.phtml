<?php 
declare(strict_types=1);

// URL-Parameter sollten idealerweise bereits in $tpl vorhanden sein.
// Falls nicht, initialisieren wir sie:
$tpl->path   = $tpl->path ?? '';
$tpl->params = $tpl->params ?? [];

// Slug-Parameter extrahieren (wichtig für URL-Mapping)
$slug  = $tpl->params['slug']  ?? null;

// BlogManager initialisieren, falls noch nicht vorhanden
$tpl->blogManager = $blogManager;

// Blog-Beitrag anhand des Slugs abrufen (URL-Mapping sollte das korrekte ID finden)
$tpl->post = $tpl->blogManager->getPostBySlug($slug);

// Prüfen, ob der Beitrag existiert
if (!$tpl->post) {
    echo '<div class="error">Dieser Blogbeitrag existiert nicht.</div>';
    return;
}

// Alle Kategorien für die Seitenleiste abrufen
$tpl->categories = $tpl->blogManager->getCategories();
?>

<div class="blog-container">
    <div class="blog-main">
        <article class="blog-post">
            <header class="post-header">
                <h1 class="post-title"><?= htmlspecialchars($tpl->post['title'], ENT_QUOTES, 'UTF-8'); ?></h1>
                <div class="post-meta">
                    <span class="post-date"><?= $helper->formatDate($tpl->post['date'], 'd.m.Y'); ?></span>
                    <span class="post-author">von <?= htmlspecialchars($tpl->post['author'], ENT_QUOTES, 'UTF-8'); ?></span>
                    <?php if (!empty($tpl->post['categories'])): ?>
                        <span class="post-categories">
                            in
                            <?php
                            $categoryLinks = [];
                            foreach ($tpl->post['categories'] as $cat) {
                                if (!empty($cat)) {
                                    $categoryLinks[] = '<a href="' . $helper->getSiteUrl('blog?category=' . urlencode($cat)) . '">' . htmlspecialchars($cat, ENT_QUOTES, 'UTF-8') . '</a>';
                                }
                            }
                            echo safe_implode(', ', $categoryLinks);
                            ?>
                        </span>
                    <?php endif; ?>
                </div>
            </header>

            <?php if (!empty($tpl->post['featured_image'])): ?>
                <div class="post-featured-image">
                    <img src="<?= $helper->getSiteUrl($tpl->post['featured_image']); ?>" alt="<?= htmlspecialchars($tpl->post['title'], ENT_QUOTES, 'UTF-8'); ?>">
                </div>
            <?php endif; ?>

            <div class="post-content">
                <?= $tpl->post['content']; ?>
            </div>

            <?php if (!empty($tpl->post['tags'])): ?>
                <div class="post-tags">
                    <span class="tags-title">Tags:</span>
                    <?php
                    $tagLinks = [];
                    foreach ($tpl->post['tags'] as $tag) {
                        if (!empty($tag)) {
                            $tagLinks[] = '<a href="' . $helper->getSiteUrl('blog?tag=' . urlencode($tag)) . '" class="tag-link">' . htmlspecialchars($tag, ENT_QUOTES, 'UTF-8') . '</a>';
                        }
                    }
                    echo safe_implode(' ', $tagLinks);
                    ?>
                </div>
            <?php endif; ?>

            <div class="post-navigation">
                <a href="<?= $helper->getSiteUrl('blog'); ?>" class="back-to-blog">
                    « Zurück zum Blog
                </a>
            </div>
        </article>
    </div>

    <aside class="blog-sidebar">
        <div class="sidebar-section categories-section">
            <h3 class="sidebar-title">Kategorien</h3>
            <?php if (empty($tpl->categories)): ?>
                <p>Keine Kategorien vorhanden.</p>
            <?php else: ?>
                <ul class="categories-list">
                    <?php foreach ($tpl->categories as $cat => $count): ?>
                        <li>
                            <a href="<?= $helper->getSiteUrl('blog?category=' . urlencode($cat)); ?>">
                                <?= htmlspecialchars($cat, ENT_QUOTES, 'UTF-8'); ?> (<?= $count; ?>)
                            </a>
                        </li>
                    <?php endforeach; ?>
                </ul>
            <?php endif; ?>
        </div>
    </aside>
</div>
