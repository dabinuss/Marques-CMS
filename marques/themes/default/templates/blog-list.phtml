<?php 
declare(strict_types=1);

// URL-Parameter übernehmen
$tpl->category = $_GET['category'] ?? '';
$tpl->tag      = $_GET['tag'] ?? '';
$tpl->page     = isset($_GET['page']) ? (int)$_GET['page'] : 1;
$tpl->perPage  = $tpl->config['posts_per_page'] ?? 10;

// Blog-Beiträge abrufen
$offset = ($tpl->page - 1) * $tpl->perPage;
$posts = $blogManager->getAllPosts($tpl->perPage, $offset, $tpl->category);

// Titel anpassen
$tpl->pageTitle = 'Blog';
if (!empty($tpl->category)) {
    $tpl->pageTitle .= ' - Kategorie: ' . htmlspecialchars($tpl->category, ENT_QUOTES, 'UTF-8');
} elseif (!empty($tpl->tag)) {
    $tpl->pageTitle .= ' - Tag: ' . htmlspecialchars($tpl->tag, ENT_QUOTES, 'UTF-8');
}

// Alle Kategorien abrufen
$categories = $blogManager->getCategories();
?>

<div class="blog-container">
    <div class="blog-header">
        <h1 class="blog-title"><?= $tpl->pageTitle; ?></h1>
    </div>

    <div class="blog-main">
        <?php if (empty($posts)): ?>
            <div class="blog-no-posts">
                <p>Keine Blog-Beiträge gefunden.</p>
            </div>
        <?php else: ?>
            <?php foreach ($posts as $post): ?>
                <article class="blog-post-summary">
                    <header>
                        <h2 class="post-title">
                            <a href="<?= $helper->formatBlogUrl($post); ?>">
                                <?= htmlspecialchars($post['title'], ENT_QUOTES, 'UTF-8'); ?>
                            </a>
                        </h2>
                        <div class="post-meta">
                            <span class="post-date"><?= $helper->formatDate($post['date'], 'd.m.Y'); ?></span>
                            <span class="post-author">von <?= htmlspecialchars($post['author'], ENT_QUOTES, 'UTF-8'); ?></span>
                            <?php if (!empty($post['categories'])): ?>
                                <span class="post-categories">
                                    in
                                    <?php
                                    $categoryLinks = [];
                                    foreach ($post['categories'] as $cat) {
                                        if (!empty($cat)) {
                                            $categoryLinks[] = '<a href="' . $helper->getSiteUrl('blog?category=' . urlencode($cat)) . '">' . htmlspecialchars($cat, ENT_QUOTES, 'UTF-8') . '</a>';
                                        }
                                    }
                                    echo safe_implode(', ', $categoryLinks);
                                    ?>
                                </span>
                            <?php endif; ?>
                        </div>
                    </header>

                    <?php if (!empty($post['featured_image'])): ?>
                        <div class="post-featured-image">
                            <a href="<?= $helper->formatBlogUrl($post); ?>">
                                <img src="<?= $helper->getSiteUrl($post['featured_image']); ?>" alt="<?= htmlspecialchars($post['title'], ENT_QUOTES, 'UTF-8'); ?>">
                            </a>
                        </div>
                    <?php endif; ?>

                    <div class="post-excerpt">
                        <?= htmlspecialchars($post['excerpt'], ENT_QUOTES, 'UTF-8'); ?>
                    </div>

                    <div class="post-read-more">
                        <a href="<?= $helper->formatBlogUrl($post); ?>" class="read-more-link">
                            Weiterlesen
                        </a>
                    </div>
                </article>
            <?php endforeach; ?>

            <!-- Paginierung -->
            <div class="blog-pagination">
                <?php if ($tpl->page > 1): ?>
                    <a href="<?= $helper->getSiteUrl('blog?page=' . ($tpl->page - 1) 
                        . (!empty($tpl->category) ? '&category=' . urlencode($tpl->category) : '') 
                        . (!empty($tpl->tag) ? '&tag=' . urlencode($tpl->tag) : '')
                    ); ?>" class="pagination-prev marques-button marques-button--outline">
                        « Vorherige
                    </a>
                <?php endif; ?>

                <?php if (count($posts) === $tpl->perPage): ?>
                    <a href="<?= $helper->getSiteUrl('blog?page=' . ($tpl->page + 1) 
                        . (!empty($tpl->category) ? '&category=' . urlencode($tpl->category) : '') 
                        . (!empty($tpl->tag) ? '&tag=' . urlencode($tpl->tag) : '')
                    ); ?>" class="pagination-next marques-button marques-button--outline">
                        Nächste »
                    </a>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>

    <aside class="blog-sidebar">
        <div class="sidebar-section categories-section">
            <h3 class="sidebar-title">Kategorien</h3>
            <?php if (empty($categories)): ?>
                <p>Keine Kategorien vorhanden.</p>
            <?php else: ?>
                <ul class="categories-list">
                    <?php foreach ($categories as $cat => $count): ?>
                        <li>
                            <a href="<?= $helper->getSiteUrl('blog?category=' . urlencode($cat)); ?>">
                                <?= htmlspecialchars($cat, ENT_QUOTES, 'UTF-8'); ?> (<?= $count; ?>)
                            </a>
                        </li>
                    <?php endforeach; ?>
                </ul>
            <?php endif; ?>
        </div>
    </aside>
</div>
