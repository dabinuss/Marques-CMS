# Dynamische RewriteBase
RewriteEngine On
RewriteBase /

# ADMIN-BEREICH - Diese Regel ZUERST platzieren!
# Ausnahme für statische Dateien im Admin-Bereich
RewriteCond %{REQUEST_URI} ^/admin/assets/.*\.(css|js|jpe?g|png|gif|ico|svg|woff2?|ttf|eot)$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Erfasst sowohl /admin als auch /admin/ und weitere Unterpfade
#RewriteRule ^admin(/.*)?$ admin/index.php [L]
RewriteCond %{REQUEST_URI} ^/admin/?(.*)$
RewriteRule ^admin(/.*)?$ admin/index.php [L]

# Wenn in Unterverzeichnis installiert, diese Zeile anpassen
# RewriteBase /marques/

# Systemdateien schützen, aber .md Dateien erlauben
RewriteRule ^system/.* - [F,L]
# Erlaubt .md-Dateien für direkte Entwicklung, blockt PHP
RewriteRule ^content/.*\.(php|phtml|phar)$ - [F,L]

# Statische Dateien und Theme-Assets direkt ausliefern
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule \.(css|js|jpe?g|png|gif|ico|svg|woff2?|ttf|eot|map)$ - [L]

# Theme-Verzeichnis direkt durchlassen, wenn die Datei existiert
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^themes/ - [L]

# Assets-Verzeichnis direkt durchlassen, wenn die Datei existiert
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^assets/ - [L]

# PHP-Dateien direkt ausliefern
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^(.+\.php)$ $1 [L]

# Explizite Regel für die Startseite
RewriteRule ^$ index.php [L]

# Explizite Regel für normale Content-Seiten
RewriteRule ^([a-zA-Z0-9_-]+)/?$ index.php [L]

# Alle anderen Anfragen an index.php weiterleiten
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [L]

# Fehlerseiten anpassen
ErrorDocument 404 /index.php
ErrorDocument 403 /index.php
ErrorDocument 500 /index.php

# .htaccess-Datei schützen
<Files .htaccess>
  Order Allow,Deny
  Deny from all
</Files>

# PHP-Dateien im Cache-Verzeichnis schützen
<FilesMatch "^\.">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Zusätzliche Performance- und Sicherheitseinstellungen
<IfModule mod_headers.c>
  # Security Headers
  Header set X-Content-Type-Options "nosniff"
  Header set X-XSS-Protection "1; mode=block"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Cache-Control für statische Assets
  <FilesMatch "\.(ico|pdf|jpg|jpeg|png|gif|js|css|svg|woff|woff2|ttf|eot)$">
    Header set Cache-Control "max-age=2592000, public"
  </FilesMatch>
</IfModule>

# PHP-Einstellungen
<IfModule mod_php8.c>
  php_flag register_globals off
  php_flag magic_quotes_gpc off
  php_flag session.auto_start off
  php_value max_execution_time 300
  php_value memory_limit 512M
  php_value post_max_size 50M
  php_value upload_max_filesize 50M
</IfModule>

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{REQUEST_URI} ^/wordpress/wp-admin [NC,OR]
  RewriteCond %{REQUEST_URI} ^/wp-admin [NC,OR]
  RewriteCond %{REQUEST_URI} ^/wp-login [NC,OR]
  RewriteCond %{REQUEST_URI} ^/xmlrpc.php [NC]
  RewriteRule .* - [F,L]
</IfModule>

<IfModule mod_evasive20.c>
  DOSHashTableSize 3097
  DOSPageCount 5
  DOSSiteCount 50
  DOSPageInterval 1
  DOSSiteInterval 1
  DOSBlockingPeriod 60
</IfModule>